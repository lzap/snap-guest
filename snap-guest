#!/bin/bash
# Requirements: python-virtinst qemu-img libguestfs-mount sed bash

usage() {
cat <<USAGE
usage: $0 options

Simple script for creating copy-on-write QEMU/KVM guests. For the base image
install Fedora or RHEL (compatible), install acpid and ntpd or similar, do not
make any swap partition (use -s option), make sure the hostname is the same
as the vm name and it has "base" in it. Example: rhel-6-base.

You can have more versions of the base image e.g. rhel-6-base-1,
rhel-6-base-2 etc. If you want snap a guest from rhel-6-base, the latest version
(a version with highest suffix number) will be used.

WARNING: This script is for development and testing purposes, it is NOT
recommended to provision production systems with it. You have been warned!

OPTIONS:
  -h             Show this message
  -l             List avaiable images (with "base" in the name)
  -a             List all images
  -b [image]     Base image name (template) - required
  -t [image]     Target image name (and hostname) - required
  -n [network]   Network settings (default: "network=default")
  -k [network2]  Second network NIC settings (none by default)
  -m [MB]        Memory (default: 800 MiB)
  -c [CPUs]      Number of CPUs (default: 1)
  -p [path]      Target images path (default: /var/lib/libvirt/images/)
  -e [path]      Base images path (default: /var/lib/libvirt/images/)
  -d [domain]    Domain suffix like "mycompany.com" (default: none)
  -f             Force creating new guest (no questions)
  -w             Add IP address to /etc/hosts (works only with NAT)
  -g             Graphics options passed to virt-install via --graphics
                 (default is vnc,listen=0.0.0.0)
  -s             Swap size (in MB) that is appeded as /dev/sdb to fstab
  -1 [command]   Command to execute during first boot in /root dir
                 (logfile available in /root/firstboot.log)

EXAMPLE:

  $0 -l
  $0 -p /mnt/data/images -l
  $0 -b fedora-17-base -t test-vm -s 4098
  $0 -b fedora-17-base -t test-vm2 -n bridge=br0 -d example.com
  $0 -b rhel-6-base -t test-vm -m 2048 -c 4 -p /mnt/data/images
USAGE
}

SOURCE_NAME=""
TARGET_NAME=""
NETWORK="network=default"
NETWORK2=""
MEM="800"
SWAP=0
CPUS="1"
IMAGE_DIR="/var/lib/libvirt/images"
BASE_IMAGE_DIR="/var/lib/libvirt/images"
DOMAIN=""
FORCE=0
LIST=0
LIST_ALL=0
ADD_IP=0
GRAPHICS_OPTS="vnc,listen=0.0.0.0"
COMMAND=""

while getopts "hlafwb:t:n:m:c:d:p:s:k:1:e:g:" opt; do
  case $opt in
    l)
      LIST=1
      ;;
    a)
      LIST_ALL=1
      ;;
    f)
      FORCE=1
      ;;
    w)
      ADD_IP=1
      ;;
    p)
      IMAGE_DIR="$OPTARG"
      ;;
    e)
      BASE_IMAGE_DIR="$OPTARG"
      ;;
    b)
      SOURCE_NAME="$OPTARG"
      ;;
    g)
      GRAPHICS_OPTS="$OPTARG"
      ;;
    t)
      TARGET_NAME="$OPTARG"
      ;;
    n)
      NETWORK="$OPTARG"
      ;;
    k)
      NETWORK2="--network=$OPTARG"
      ;;
    m)
      MEM="$OPTARG"
      ;;
    c)
      CPUS="$OPTARG"
      ;;
    d)
      DOMAIN=".$OPTARG"
      ;;
    s)
      SWAP="$OPTARG"
      ;;
    1)
      COMMAND="$OPTARG"
      ;;
    h)
      usage
      exit
      ;;
    ?)
      echo "Invalid option: $OPTARG" >&2
      usage
      exit
      ;;
  esac
done

[ $LIST -eq 1 ] && ls "$BASE_IMAGE_DIR" | grep '\.img' | grep base | sed 's/\.img//g' && exit 0
[ $LIST_ALL -eq 1 ] && ls "$BASE_IMAGE_DIR" | grep '\.img' | sed 's/\.img//g' && exit 0

if [ -z "$SOURCE_NAME" -o -z "$TARGET_NAME" ]; then
  usage
  exit 1
fi

SOURCE_IMG=$(ls -v1 $BASE_IMAGE_DIR/${SOURCE_NAME}*.img | tail -n1)
TARGET_IMG=$IMAGE_DIR/$TARGET_NAME.img
TARGET_IMG_SWAP=$IMAGE_DIR/$TARGET_NAME-swap.img
MAC="52:54:00$(echo "$(hostname)$TARGET_NAME" | openssl dgst -md5 -binary | hexdump -e '/1 ":%02x"' -n 3)"
HOSTNM="$TARGET_NAME$DOMAIN"

if [ ! -f "$SOURCE_IMG" ]; then
  echo "Base image $SOURCE_IMG not found!"
  exit 1
fi

if [ -f "$TARGET_IMG" ]; then
  echo "Target image already exists!"
  if [ $FORCE -eq 1 ]; then
    REPLY="y"
  else
    read -p "Shutdown and remove host with this name first (y/[n])? "
  fi
  [ "$REPLY" != "y" ] && \
    # need to do it twice (sometimes this fail)
    virsh destroy "$TARGET_NAME" 2>/dev/null; sleep 2s; \
    virsh destroy "$TARGET_NAME" 2>/dev/null; sleep 1s; \
    virsh undefine "$TARGET_NAME"
fi

echo "Creating snapshot guest $TARGET_NAME"

# -- Image Creation --------------

echo "Creating snapshot image"
qemu-img create -f qcow2 -b $SOURCE_IMG $TARGET_IMG

# -- Image Manipulation ----------

export BASE_IMAGE_DIR COMMAND HOSTNM MAC SOURCE_NAME SWAP TARGET_IMG TARGET_NAME

perl -w -e '
use strict;
use Sys::Guestfs;

my $g = Sys::Guestfs->new ();

# For debugging.
#$g->set_trace (1);

# Add the disk and launch.
$g->add_drive_opts ($ENV{TARGET_IMG}, format => "qcow2");
$g->launch ();

# Inspect for OSes.
my @roots = $g->inspect_os ();
die "no operating system was found" if @roots == 0;
die "dual/multi-boot operating system not supported" if @roots > 1;
my $root = $roots[0];

# Get OS and version.
my $type = $g->inspect_get_type ($root);
my $distro = $g->inspect_get_distro ($root);
my $major = $g->inspect_get_major_version ($root);
my $minor = $g->inspect_get_minor_version ($root);

print "OS: $type $distro $major $minor\n";

# Mount up the operating system disks.
my %mps = $g->inspect_get_mountpoints ($root);
my @mps = sort { length $a <=> length $b } (keys %mps);
for my $mp (@mps) {
  eval { $g->mount ($mps{$mp}, $mp) }
}

print "Disable fsck startup check for all volumes\n";
my $file;
my $content;
$file = "/etc/fstab";
$content = $g->read_file ($file);
$content =~ s/[0-9]$/0/g;
$g->write ($file, $content);

print "Configuring message of the day\n";
$content = "\n\nSnap-guest box from $ENV{BASE_IMAGE_DIR} on " . `date` . "\n\n";
$g->write ("/etc/motd", $content);

print "Configuring /etc/hosts file\n";
$file = "/etc/hosts";
$content = $g->read_file ($file);
$content =~ s/$ENV{SOURCE_NAME}/localbox/g;
$content .= "\n127.0.0.1 $ENV{TARGET_NAME} $ENV{HOSTNM}\n";
$g->write ($file, $content);

if ($distro eq "debian" || $distro eq "ubuntu") {
  print "Setting up for Debian\n";
  # nothing
}
elsif ($distro =~ m/^(fedora|rhel|redhat-based|centos|scientificlinux)$/) {
  print "Setting up for Fedora / RHEL\n";
  print "Setting MAC address\n";
  $file = "/etc/sysconfig/network-scripts/ifcfg-eth0";
  $content = $g->read_file ($file);
  $content =~ s/HWADDR=.*/HWADDR=$ENV{MAC}/g;
  $g->write ($file, $content);

  print "Setting hostname\n";
  if ($major >= 18) {
    $g->write ("/etc/hostname", $ENV{HOSTNM});
  } else {
    $file = "/etc/sysconfig/network";
    my @lines = $g->read_lines ($file);
    my $found_it = 0;
    foreach (@lines) {
      s/HOSTNAME=.*/HOSTNAME=$ENV{HOSTNM}/;
      $found_it = 1;
    }
    if (!$found_it) {
      push @lines, "# added by snap-guest", "HOSTNAME=$ENV{HOSTNM}";
    }
    $g->write ($file, join ("\n", @lines) . "\n");
  }
}

if ($ENV{SWAP}) {
  print "Adding swap file\n";
  $file = "/etc/fstab";
  $content = $g->read_file ($file);
  $content .= "\n/dev/vdb none swap swap 0 0\n";
  $g->write ($file, $content);
}

if ($ENV{COMMAND}) {
  print "Preparing fristboot command and tt watch progress alias\n";
  $content = "pushd /root\n$ENV{COMMAND}\npopd\n";
  $g->write ("/root/firstboot.sh", $content);

  $file = "/etc/rc.d/rc.local";
  if ($g->exists ($file)) {
    $content = $g->read_file ($file);
  } else {
    $content = "#!/bin/bash\n";
  }
  $content .= "\nbash -x /root/firstboot.sh 2>&1 | /usr/bin/tee /root/firstboot.log\n";
  $g->write ($file, $content);
  $g->chmod (0755, $file);

  $file = "/root/.bashrc";
  if ($g->exists ($file)) {
    $content = $g->read_file ($file);
  } else {
    $content = "";
  }
  $content .= "\n# snap-guest\nalias tt=\"tail -f -n500 /root/firstboot.log\"";
  $g->write ($file, $content);
}

# Shutdown the appliance cleanly.
$g->umount_all ();
$g->shutdown ();
$g->close ();
'

# -- Swap Creation --------------

if [ $SWAP -gt 0 ]; then
  qemu-img create -f raw $TARGET_IMG_SWAP ${SWAP}M
  mkswap -f $TARGET_IMG_SWAP
  DISK_SWAP="--disk $TARGET_IMG_SWAP,device=disk,bus=virtio,format=raw"
else
  DISK_SWAP=""
fi

# -- Image Provisioning ---------

echo "Provisioning guest $TARGET_NAME"
echo "Hostname: $HOSTNM"
echo "CPUs:     $CPUS"
echo "Memory:   $MEM MB"
echo "Swap:     $MEM MB"
echo "MAC:      $MAC"
virt-install --vcpus $CPUS \
  --ram $MEM --import \
  --name $TARGET_NAME \
  --disk $TARGET_IMG,device=disk,bus=virtio,format=qcow2 $DISK_SWAP \
  --graphics "$GRAPHICS_OPTS" \
  --noautoconsole --force \
  --network=$NETWORK,mac=$MAC \
  $NETWORK2

# -- IP Determining -------------

if [ $ADD_IP -eq 1 ]; then
  echo "Waiting for IP"
  i=0
  until [ $i -ge 100 ] || IP_LINE=`cat /var/lib/libvirt/dnsmasq/${NETWORK/network=}.leases /var/lib/dnsmasq/dnsmasq.leases 2>/dev/null | grep "$MAC"`; do
    i=$((i + 1))
    sleep 1
  done

  if [[ -n $IP_LINE ]]; then
    IP=`echo  $IP_LINE | awk '{print $3}'`
    if ! grep -q "$HOSTNM\$" /etc/hosts; then
      echo "Writing into /etc/hosts ip: $IP"
      echo "$IP $HOSTNM $TARGET_NAME" >> /etc/hosts
    else
      echo "Host $HOSTNM already in hosts"
      OLD_IP=`grep "$HOSTNM\$" /etc/hosts | head -n 1 | awk '{print $1}'`
      if [[ $IP = $OLD_IP ]]; then
        echo "and these ip's match"
      else
        echo "with different ip: $OLD_IP instead of $IP"
      fi
    fi
  fi
fi

# -- EOF --

